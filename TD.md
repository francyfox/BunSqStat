# ТЗ: SqStat v2.0 - Система мониторинга Squid прокси

## 1. ЗАДАЧА ОТ ЗАКАЗЧИКА

Переписать существующую PHP систему мониторинга прокси-сервера Squid на современные технологии Bun + Elysia.

**Что есть сейчас**: PHP скрипт 2006 года, который показывает активные соединения Squid в веб-интерфейсе.

**Что нужно получить**: Современное веб-приложение с real-time обновлениями.

---

## 2. ИСТОЧНИК ДАННЫХ - SQUID PROXY

### 2.1 Подключение к Squid
**К чему подключаться**:
- Squid прокси-сервер на указанном IP и порту
- Протокол: TCP соединение к порту прокси (обычно 3128)
- Эндпоинт: `cache_object://localhost/active_requests`

**Как подключаться**:
```
Отправить HTTP запрос:
GET cache_object://localhost/active_requests HTTP/1.0
Authorization: Basic <base64(cachemgr:пароль)>
```

**Пример настроек подключения**:
- Хост: 192.168.10.1
- Порт: 3128
- Пароль: secret
- Таймаут: 10 секунд

### 2.2 Что получаете от Squid
**Формат ответа**:
```
HTTP/1.1 200 OK
Server: squid/5.7

Connection: 12345
username alex
remote: 192.168.1.100:54321
local: 192.168.1.1:3128
uri http://example.com/file.pdf
out.offset 1024, out.size 2048576
start 1234567890.123 (45.6 seconds ago)
delay_pool 1

Connection: 12346
username maria
remote: 192.168.1.101:45678
...
```

**Обязательные поля для парсинга**:
- `Connection: номер` - ID соединения
- `username` - имя пользователя
- `remote:` - IP:порт клиента
- `local:` - IP:порт прокси
- `uri` - URL который загружается
- `out.size` - количество переданных байт
- `start ... (X seconds ago)` - длительность соединения

**Дополнительные поля (Squid 5.7+)**:
- `client_protocol` - версия HTTP
- `request_method` - GET/POST/etc
- `response_code` - код ответа
- `delay_pool` - номер пула ограничений

---

## 3. ЧТО НУЖНО ВЫВЕСТИ ПОЛЬЗОВАТЕЛЮ

### 3.1 Главная страница - Dashboard
**Обязательные элементы**:

1. **Шапка с основными метриками**:
   - Общее количество пользователей
   - Общее количество соединений
   - Общая текущая скорость (KB/s)
   - Общая средняя скорость (KB/s)

2. **Таблица активных соединений**:
   - Колонки: Пользователь, URL, Текущая скорость, Средняя скорость, Размер, Время
   - Сортировка по любой колонке
   - Поиск/фильтрация по пользователю или URL
   - Группировка соединений по пользователям

3. **Настройки отображения**:
   - Переключатель серверов (если их несколько)
   - Интервал обновления (1-60 сек)
   - Кнопки Обновить/Остановить автообновление

### 3.2 Расчеты которые нужно выполнить

**Текущая скорость**:
- Сравнить текущий размер соединения с предыдущим
- Разделить на время между замерами
- Результат в KB/s

**Средняя скорость**:
- Общий размер соединения / время существования соединения
- Результат в KB/s

**Группировка**:
- По пользователям: показать пользователя и все его соединения
- По хостам: показать IP и все соединения с этого IP

### 3.3 Дополнительные функции

**Обязательные**:
- Экспорт таблицы в CSV
- Адаптивный дизайн (работа на мобильных)
- Темная/светлая тема

**Желательные**:
- Графики скорости в реальном времени
- История подключений
- Уведомления о превышении лимитов

---

## 4. КОНФИГУРАЦИЯ

### 4.1 Формат настроек
**Файл конфигурации** (JSON):
```json
{
  "servers": [
    {
      "id": "main",
      "name": "Основной прокси",
      "host": "192.168.10.1",
      "port": 3128,
      "password": "secret",
      "resolveIp": false,
      "groupBy": "username"
    }
  ],
  "ui": {
    "maxUrlLength": 60,
    "refreshInterval": 5000,
    "theme": "light"
  }
}
```

### 4.2 Миграция с PHP версии
**Требование**: Создать утилиту конвертации настроек из `config.inc.php`:

Исходный PHP формат:
```php
$squidhost[0]="192.168.10.1";
$squidport[0]=3128;
$cachemgr_passwd[0]="secret";
$group_by[0]="username";
```

Должен автоматически конвертироваться в новый JSON формат.

---

## 5. ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ

### 5.1 Обязательные технологии
- **Backend**: Bun + Elysia
- **Frontend**: На ваш выбор (React/Vue/Svelte)
- **Типизация**: TypeScript
- **Стилизация**: TailwindCSS
- **Контейнеризация**: Docker

### 5.2 Real-time обновления
**Требование**: Данные должны обновляться автоматически без перезагрузки страницы.
- Использовать WebSocket для push обновлений
- Fallback на HTTP polling если WebSocket недоступен
- Настраиваемый интервал обновления

### 5.3 API endpoints
**Обязательные**:
- `GET /api/stats` - получить текущую статистику
- `GET /api/config` - получить конфигурацию
- `POST /api/config` - обновить конфигурацию
- `GET /api/health` - статус приложения
- `WS /api/ws/stats` - WebSocket для real-time

### 5.4 Совместимость
**Обязательно поддерживать**:
- Squid 5.7+ (основная версия)
- Squid 4.x (обратная совместимость)
- Squid 3.x (базовая поддержка)

**Автоопределение версии**: Приложение должно само определять версию Squid и использовать соответствующий парсер.

---

## 6. КАЧЕСТВО И ПРОИЗВОДИТЕЛЬНОСТЬ

### 6.1 Производительность
- API должен отвечать менее чем за 100мс
- WebSocket задержка менее 50мс
- Поддержка до 1000 одновременных соединений
- Потребление памяти менее 100MB

### 6.2 Надежность
- Приложение не должно падать при недоступности Squid
- Автоматическое переподключение при обрывах связи
- Graceful shutdown по SIGTERM
- Логирование всех ошибок

### 6.3 Безопасность
- Валидация всех входящих данных
- Rate limiting для API
- Защита от XSS/CSRF
- HTTPS в production

---

## 7. ДЕПЛОЙ И ДОКУМЕНТАЦИЯ

### 7.1 Контейнеризация
**Docker requirements**:
- Dockerfile для сборки приложения
- docker-compose.yml для быстрого запуска
- Размер образа менее 200MB
- Переменные окружения для конфигурации

### 7.2 Документация
**Обязательные файлы**:
- README.md с инструкцией по запуску
- API.md с описанием всех endpoints
- MIGRATION.md с инструкцией миграции с PHP
- docker-compose пример с Nginx

---

## 8. ПРИЕМКА РЕЗУЛЬТАТА

### 8.1 Функциональные критерии
✅ Успешное подключение к Squid серверу  
✅ Отображение активных соединений в реальном времени  
✅ Корректный расчет скоростей (текущая/средняя)  
✅ Группировка по пользователям и хостам  
✅ Сортировка и фильтрация в таблице  
✅ Экспорт данных в CSV  
✅ Адаптивный интерфейс  
✅ Переключение темы (светлая/темная)  
✅ Конфигурация через JSON файл  
✅ Миграция настроек с PHP версии

### 8.2 Технические критерии
✅ API response time < 100ms  
✅ WebSocket updates < 50ms  
✅ Docker deployment работает  
✅ Автоопределение версии Squid  
✅ Graceful shutdown  
✅ Health check endpoint

### 8.3 Документация
✅ README с инструкцией запуска  
✅ API документация  
✅ Инструкция миграции  
✅ Примеры конфигураций

---

## 9. ПРИМЕРЫ ДАННЫХ ДЛЯ ТЕСТИРОВАНИЯ

### 9.1 Тестовый ответ от Squid
```
HTTP/1.1 200 OK
Server: squid/5.7

Connection: 001
username alex
remote: 192.168.1.100:54321
local: 192.168.1.1:3128  
uri http://example.com/video.mp4
out.offset 1024000, out.size 5242880
start 1699123456.789 (45 seconds ago)
delay_pool 1

Connection: 002
username maria
remote: 192.168.1.101:45678
local: 192.168.1.1:3128
uri https://cdn.example.com/image.jpg  
out.offset 0, out.size 1048576
start 1699123500.123 (1 seconds ago)
```

### 9.2 Ожидаемый результат обработки
```json
{
  "serverVersion": "squid/5.7",
  "timestamp": 1699123501000,
  "connections": [
    {
      "id": "001",
      "username": "alex", 
      "remoteAddress": "192.168.1.100:54321",
      "uri": "http://example.com/video.mp4",
      "bytes": 5242880,
      "duration": 45,
      "currentSpeed": 116.4,
      "averageSpeed": 116.4
    },
    {
      "id": "002", 
      "username": "maria",
      "remoteAddress": "192.168.1.101:45678", 
      "uri": "https://cdn.example.com/image.jpg",
      "bytes": 1048576,
      "duration": 1,
      "currentSpeed": 1024.0,
      "averageSpeed": 1024.0
    }
  ],
  "users": [
    {
      "name": "alex",
      "connections": [/* connection 001 */],
      "totalBytes": 5242880,
      "currentSpeed": 116.4,
      "averageSpeed": 116.4
    },
    {
      "name": "maria", 
      "connections": [/* connection 002 */],
      "totalBytes": 1048576,
      "currentSpeed": 1024.0,
      "averageSpeed": 1024.0
    }
  ],
  "summary": {
    "totalUsers": 2,
    "totalConnections": 2,
    "currentSpeed": 1140.4,
    "averageSpeed": 1140.4,
    "totalBytes": 6291456
  }
}
```

---

## 10. КОНТАКТЫ

**Исходные файлы**: `/home/fox/WebstormProjects/SqStat-master/`  
**Оригинальный автор**: Alex Samorukov (samm@os2.kiev.ua)  
**Заказчик**: [ваши контакты]  
**Дата ТЗ**: 2024-09-04  
**Срок выполнения**: [указать срок]

---

**ВАЖНО**: Результат должен полностью заменить PHP версию с сохранением всей функциональности + добавлением modern UI и real-time обновлений.
