services:
#  bunsqstat_client:
#    image: ghcr.io/francyfox/bunsqstat:v0.1.3
#    container_name: bunsqstat-client
#    restart: unless-stopped
#    ports:
#      - "80:80"      # Web interface
#      - "3000:3000"  # API (optional, for direct access)
#      - "6379:6379"  # Redis (optional, for external access)
#    environment:
#      - NODE_ENV=production # optional
#      - REDIS_PASSWORD=123 # optional
#      - SQUID_HOST=127.0.0.1 # optional
#      - SQUID_PORT=3128 # optional
#      - LOG_DIR=/app/logs
#    volumes:
#      - ./logs:/app/logs
#    healthcheck:
#      test: ["CMD", "curl", "-f", "http://localhost/api/health"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 30s

  redis:
    container_name: redis-bunsqstat
    image: redis/redis-stack:7.2.0-v18
    restart: unless-stopped
    ports:
      - "6379:6379"
    environment:
      - ALLOW_EMPTY_PASSWORD=false
      - REDIS_AOF_ENABLED=no
      - REDIS_PASSWORD=123
    command: redis-server ./redis-stack.conf --requirepass 123
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
    volumes:
      - ./docker/redis/redis.conf:/redis-stack.conf
      - predis_data:/data
    networks:
      local:

  squid:
    user: "3128:3128"
    image: ghcr.io/b4tman/squid-ssl-bump:latest
    restart: unless-stopped
    ports:
      - "3128:3128"
      - "3129:3129"
    volumes:
      - ./docker/ssl:/etc/squid/ssl/
      - ./docker/squid.conf:/etc/squid/conf.d/squid.conf:ro
      - ./logs:/var/log/squid
    environment:
      - SQUID_CONFIG_FILE=/etc/squid/conf.d/squid.conf
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    networks:
      - squid-net

  squidanalyzer:
    image: coun/squidanalyzer:latest
    container_name: squidanalyzer  
    restart: unless-stopped
    ports:
      - "8080:8090"  # Web interface для SquidAnalyzer
    volumes:
      - ./logs:/var/log/squid:ro  # Логи Squid только для чтения
      - squidanalyzer_data:/var/www/html  # Данные отчетов
      - ./docker/squidanalyzer.conf:/etc/squidanalyzer/squidanalyzer.conf:ro
    depends_on:
      - squid
    networks:
      - squid-net
    environment:
      - TZ=Asia/Almaty
      - LANG=ru_RU
      - LOGIN=admin
      - PASS=123456
      - LOCALE=ru_RU
      - PATHLOGS=/var/log/squid/access.log

volumes:
  predis_data:
  squidanalyzer_data:

networks:
  local:
  squid-net:
    driver: bridge