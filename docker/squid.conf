# PID file location
pid_filename /var/run/squid/squid.pid

# HTTP port
http_port 3128

sslproxy_cert_error allow all
http_port 3129 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl/squid.pem key=/etc/squid/ssl/squid.key
ssl_bump server-first all
ssl_bump bump all
always_direct allow all

auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwords
auth_param basic realm "Enter username and password"

# Access control lists
acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
acl localnet src fc00::/7        # RFC 4193 local private network range
acl localnet src fe80::/10       # RFC 4291 link-local (directly plugged) machines

acl SSL_ports port 443
acl Safe_ports port 80 21 443 70 210 1025-65535 280 488 591 777 3129
acl CONNECT method CONNECT

# Аутентификация пользователей
acl authenticated_users proxy_auth REQUIRED

# Разрешить кеширование для аутентифицированных запросов
cache allow authenticated_users

# --- Правила доступа (ACL) ---

# 1. Разрешить менеджеру кэша доступ только с localhost
http_access allow localhost manager
http_access deny manager

# 2. Разрешить CONNECT (для HTTPS-туннеля) из локальной сети и localhost
http_access allow CONNECT localnet
http_access allow CONNECT localhost

# 3. Запретить CONNECT для портов, не являющихся SSL (443)
http_access deny CONNECT !SSL_ports

# 4. Запретить доступ к портам, не входящим в Safe_ports
http_access deny !Safe_ports

# 5. Разрешить аутентифицированным пользователям
http_access allow authenticated_users

# 6. Разрешить весь остальной HTTP/HTTPS-трафик для локальной сети и localhost
http_access allow localnet
http_access allow localhost

# 6. !!! ГЛАВНОЕ ИСПРАВЛЕНИЕ: Явно запретить весь остальной доступ !!!
http_access deny all

# --- Конец правил доступа ---

# Cache directory
cache_dir ufs /var/cache/squid 5000 16 256

# Log rotation settings
logfile_rotate 7

# Access log
access_log udp://bunsqstat_client:5140 squid
cache_log stdio:/var/log/squid/cache.log

# Refresh patterns
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320