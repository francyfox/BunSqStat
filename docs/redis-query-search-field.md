# Документация по запросам Redis для поля поиска на фронтенде

## Обзор

Поле поиска (search field) на фронтенде BunSqStat использует утилиту `buildSearchQuery` из файла `apps/web/src/utils/redis-query.ts` для построения запросов к Redis Search. Эти запросы основаны на синтаксисе RediSearch и адаптированы под типы полей в индексе логов Squid.

Функция `buildSearchQuery` принимает:
- `field`: Имя поля с префиксами `@` и `:` (например, `@clientIP:`).
- `searchValue`: Значение для поиска (строка или null).

Если значение пустое, возвращается `*` (поиск по всем записям).

## Типы полей и обработка запросов

Запросы строятся с учетом типа поля для оптимальной производительности и корректности:

### 1. `clientIP` (TAG поле, IP-адреса)
- Заменяет точки на `*` для wildcard-поиска подсетей.
- Пример: `192.168.1.1` → `@clientIP:192*168*1*1`
- Подходит для поиска IP-диапазонов, например, локальной сети.

### 2. `user` (TAG/TEXT поле, идентификаторы пользователей)
- Если значение содержит `@` (email), использует TAG-запрос с экранированием.
- Иначе — TEXT-запрос для частичного поиска.
- Пример: `alice` → `@user:alice` (TEXT); `user@domain.com` → `@user:{user\\@domain\\.com}` (TAG).

### 3. `resultType` и `method` (TAG поля, типы результатов и HTTP-методы)
- Использует фигурные скобки для точного совпадения с wildcard.
- Пример: `TCP_HIT` → `@resultType:{TCP*HIT*}`; `GET` → `@method:{GET*}`.

### 4. `hierarchyType`, `contentType`, `url` (TEXT поля)
- Для `url` удаляет протокол (`http://` или `https://`).
- Использует TEXT-запрос для полнотекстового поиска.
- Пример: `https://google.com` → `@url:google.com` (поиск по "google.com").

### 5. `hierarchyHost` (TAG поле, хосты)
- Аналогично IP: заменяет точки на `*`.
- Пример: `example.com` → `@hierarchyHost:example*com`.

### 6. Числовые поля: `timestamp`, `duration`, `resultStatus`, `bytes` (NUMERIC)
- Если значение в формате диапазона `[min max]`, использует как есть.
- Иначе создает равный диапазон `[value value]`.
- Пример: `200` → `@resultStatus:[200 200]`; `[200 299]` → `@resultStatus:[200 299]`.

### 7. По умолчанию (TEXT)
- Для неизвестных полей использует TEXT-запрос.

## Интеграция с фронтендом

В сторе `stats.ts` (Pinia) функция `getAccessLogs` передает параметры запроса в API:
```typescript
const response = await api.stats["access-logs"].get({ query });
```
Параметр `query` может включать построенный поисковый запрос, который отправляется на бэкенд.

Бэкенд (в `modules/access-logs/service.ts`) выполняет `FT.SEARCH` с этим запросом, например:
```
FT.SEARCH log_idx "@timestamp:[start end] @resultType:*HIT*" LIMIT 0 100
```

## Примеры построения запросов

### Простой поиск
- Значение: `google` (поле `@url:`) → `@url:google`

### Поиск по IP
- Значение: `192.168.1` (поле `@clientIP:`) → `@clientIP:192*168*1*`

### Диапазон статусов
- Значение: `200-299` (поле `@resultStatus:`) → `@resultStatus:[200 299]`

### Комбинированный запрос
На фронтенде запросы комбинируются через пробел (AND по умолчанию):
```
@clientIP:192*168*1* @user:alice @resultStatus:[200 299]
```

## Советы по использованию

- **Экранирование**: Функция автоматически экранирует специальные символы для TAG-полей.
- **Wildcard**: Для TAG-полей (IP, host) используйте `*` для подстановок.
- **Диапазоны**: Для числовых полей указывайте `[min max]` для фильтрации.
- **Производительность**: Предпочитайте TAG для точных совпадений, TEXT — для fuzzy-поиска.
- **Тестирование**: Используйте Redis CLI для проверки: `FT.SEARCH log_idx "ваш_запрос" LIMIT 0 10`.

Для более детального синтаксиса RediSearch см. [официальную документацию](https://redis.io/docs/stack/search/reference/query_syntax/).

Если нужно расширить функциональность, добавьте обработку новых полей в `buildSearchQuery`.

